<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Loading Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .feature-item h4 {
            margin: 0 0 10px 0;
            color: #3b82f6;
        }
        .feature-item p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .code {
            background: #f1f3f4;
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        .error-demo {
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .fix-demo {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîê Authentication Loading Fix Test</h1>
    
    <div class="test-section">
        <h2>üìã Test Overview</h2>
        <p>This test verifies that the authentication loading issues have been fixed, including 403/406 errors and stuck "Loading profile..." states.</p>
        <p><strong>Issues Fixed:</strong></p>
        <ul>
            <li>403 Forbidden errors when fetching user profiles</li>
            <li>406 Not Acceptable errors from Supabase</li>
            <li>User profile not found in database</li>
            <li>Stuck "Loading profile..." state</li>
            <li>Authentication state not properly cleared on sign out</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>‚ùå Previous Issues</h2>
        
        <div class="error-demo">
            <h3>üî¥ Console Errors (Before Fix):</h3>
            <div class="log error">
Failed to load resource: riqsgtuzccwpplbodwbd.supabase.co/auth/v1/user:1 
the server responded with a status of 403 ()

Auth state changed: SIGNED_OUT undefined
No session user, clearing user state
No authenticated user, using default appearance config

Failed to load resource: riqsgtuzccwpplbodwbd.supabase.co/rest/v1/profiles?select=*&id=eq.6ceca7f2-9014-470d-a4ac-3cf81cfd771b:1 
the server responded with a status of 406 ()

Error fetching user profile (attempt 1): Object
User profile not found in database
Profile enhancement failed, keeping basic user data

‚ö†Ô∏è Initial profile enhancement failed, keeping basic user data
            </div>
        </div>

        <div class="error-demo">
            <h3>üî¥ UI Issues (Before Fix):</h3>
            <ul>
                <li><strong>Stuck Loading:</strong> "Loading profile..." spinner never disappears</li>
                <li><strong>403 Errors:</strong> Authentication/authorization failures</li>
                <li><strong>406 Errors:</strong> Profile not found in database</li>
                <li><strong>No Fallback:</strong> No graceful handling of missing profiles</li>
                <li><strong>Infinite Loading:</strong> No timeout mechanism</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Fixes Applied</h2>
        
        <div class="feature-list">
            <div class="feature-item">
                <h4>üîí 403/406 Error Handling</h4>
                <p>Added specific handling for authentication and profile not found errors</p>
                <div class="code">
// Handle 403 authentication errors
if (error.message?.includes('403') || error.code === 'PGRST301') {
  console.log('üîí Authentication error, user may not be properly authenticated');
  setProfileLoading(false);
  return null;
}

// Handle 406 profile not found errors
if (error.code === 'PGRST116' || error.message?.includes('406')) {
  console.log('üìù User profile not found in database');
  setProfileLoading(false);
  return null;
}
                </div>
            </div>
            <div class="feature-item">
                <h4>‚è∞ Timeout Mechanism</h4>
                <p>Added 10-second timeout to prevent infinite loading states</p>
                <div class="code">
// Set a timeout to prevent infinite loading
const timeoutId = setTimeout(() => {
  console.log('‚è∞ Profile loading timeout, clearing loading state');
  setProfileLoading(false);
}, 10000); // 10 second timeout
                </div>
            </div>
            <div class="feature-item">
                <h4>üîÑ Loading State Management</h4>
                <p>Ensured profile loading state is cleared in all error paths</p>
                <div class="code">
// Clear loading state in all error scenarios
setProfileLoading(false);

// Clear loading state when signed out
setUser(null);
setProfileLoading(false); // Clear profile loading state when signed out
                </div>
            </div>
            <div class="feature-item">
                <h4>üõ°Ô∏è Graceful Fallbacks</h4>
                <p>Added proper fallback mechanisms for missing profiles</p>
                <div class="code">
// Return null to use basic user data from session
if (error.code === 'PGRST116' || error.message?.includes('406')) {
  console.log('üìù User profile not found in database');
  setProfileLoading(false);
  return null; // Use basic user data from session
}
                </div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîß Technical Implementation</h2>
        
        <h3>1. Enhanced Error Handling</h3>
        <div class="code">
const getUserProfile = async (userId: string): Promise<AuthUser | null> => {
  const maxRetries = 1;
  let retryCount = 0;
  setProfileLoading(true);
  
  // Set a timeout to prevent infinite loading
  const timeoutId = setTimeout(() => {
    console.log('‚è∞ Profile loading timeout, clearing loading state');
    setProfileLoading(false);
  }, 10000); // 10 second timeout
  
  try {
    while (retryCount <= maxRetries) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .single();

        if (error) {
          // Handle specific error types
          if (error.code === 'PGRST116' || error.message?.includes('406')) {
            console.log('üìù User profile not found in database');
            clearTimeout(timeoutId);
            setProfileLoading(false);
            return null;
          }
          
          if (error.message?.includes('403') || error.code === 'PGRST301') {
            console.log('üîí Authentication error');
            clearTimeout(timeoutId);
            setProfileLoading(false);
            return null;
          }
          
          // Retry logic for other errors
          if (retryCount < maxRetries) {
            retryCount++;
            await new Promise(resolve => setTimeout(resolve, 500));
            continue;
          }
          
          clearTimeout(timeoutId);
          setProfileLoading(false);
          return null;
        }

        // Success case
        clearTimeout(timeoutId);
        setProfileLoading(false);
        return profileData;
      } catch (err) {
        // Exception handling with timeout cleanup
        clearTimeout(timeoutId);
        setProfileLoading(false);
        return null;
      }
    }
  } catch (err) {
    // Outer exception handling
    clearTimeout(timeoutId);
    setProfileLoading(false);
    return null;
  }
};
        </div>

        <h3>2. Authentication State Management</h3>
        <div class="code">
// Clear profile loading state when signed out
} else {
  console.log('üö´ No session user, clearing user state');
  setUser(null);
  setProfileLoading(false); // Clear profile loading state when signed out
}

// Set loading to false immediately for fast UI response
if (isInitialized) {
  console.log('üîÑ Auth loading state: false (user set immediately)');
  setLoading(false);
}
        </div>

        <h3>3. ProtectedRoute Integration</h3>
        <div class="code">
// Show loading spinner while checking authentication or loading profile
if (loading || profileLoading) {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="flex flex-col items-center space-y-4">
        <Loader2 className="h-8 w-8 animate-spin text-primary" />
        <p className="text-sm text-muted-foreground">
          {loading ? 'Loading...' : 'Loading profile...'}
        </p>
      </div>
    </div>
  );
}
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Test Steps</h2>
        <ol>
            <li><strong>Clear Browser Data:</strong> Clear cookies, localStorage, and sessionStorage</li>
            <li><strong>Open Developer Console:</strong> Monitor console for errors</li>
            <li><strong>Navigate to Owner Dashboard:</strong> Go to <code>http://localhost:8081/owner/view</code></li>
            <li><strong>Check Loading State:</strong> Should see loading spinner briefly</li>
            <li><strong>Verify No 403/406 Errors:</strong> Console should not show authentication errors</li>
            <li><strong>Check Profile Loading:</strong> Should not get stuck on "Loading profile..."</li>
            <li><strong>Test Sign Out:</strong> Sign out and verify loading states clear properly</li>
            <li><strong>Test Sign In:</strong> Sign in and verify smooth authentication flow</li>
            <li><strong>Test Timeout:</strong> If profile loading takes too long, should timeout after 10 seconds</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üîç Expected Behavior</h2>
        
        <div class="fix-demo">
            <h3>‚úÖ Console Output (After Fix):</h3>
            <div class="log success">
üîê Auth state changed: SIGNED_IN user@example.com
üë§ Ensuring user profile exists...
üé≠ User role from metadata: owner -> normalized: owner
‚úÖ User profile fetched successfully
üîÑ Auth loading state: false (user set immediately)
‚úÖ Enhanced user profile loaded in background: user@example.com
            </div>
        </div>

        <div class="fix-demo">
            <h3>‚úÖ UI Behavior (After Fix):</h3>
            <ul>
                <li><strong>Fast Loading:</strong> Loading spinner appears briefly and disappears</li>
                <li><strong>No Stuck States:</strong> Never gets stuck on "Loading profile..."</li>
                <li><strong>Graceful Fallbacks:</strong> Uses basic user data when profile not found</li>
                <li><strong>Proper Timeouts:</strong> Times out after 10 seconds if needed</li>
                <li><strong>Clean Sign Out:</strong> All loading states clear on sign out</li>
            </ul>
        </div>

        <div class="fix-demo">
            <h3>‚úÖ Error Handling (After Fix):</h3>
            <ul>
                <li><strong>403 Errors:</strong> Handled gracefully with proper logging</li>
                <li><strong>406 Errors:</strong> Treated as "profile not found" and handled</li>
                <li><strong>Network Errors:</strong> Retry once, then fallback to basic data</li>
                <li><strong>Timeout Errors:</strong> Clear loading state after 10 seconds</li>
                <li><strong>Exception Errors:</strong> Caught and handled with cleanup</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Key Improvements</h2>
        <ul>
            <li><strong>‚úÖ No More Stuck Loading:</strong> Loading states are properly cleared in all scenarios</li>
            <li><strong>‚úÖ Better Error Handling:</strong> Specific handling for 403/406 errors</li>
            <li><strong>‚úÖ Timeout Protection:</strong> 10-second timeout prevents infinite loading</li>
            <li><strong>‚úÖ Graceful Fallbacks:</strong> Uses basic user data when profile not found</li>
            <li><strong>‚úÖ Clean State Management:</strong> Proper cleanup on sign out</li>
            <li><strong>‚úÖ Faster Loading:</strong> Reduced retries and better error handling</li>
            <li><strong>‚úÖ Better UX:</strong> Users see loading states briefly, not indefinitely</li>
            <li><strong>‚úÖ Robust Error Recovery:</strong> System recovers gracefully from errors</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üìä Error Scenarios Handled</h2>
        
        <h3>1. Authentication Errors (403)</h3>
        <ul>
            <li><strong>Cause:</strong> Invalid or expired authentication token</li>
            <li><strong>Handling:</strong> Clear loading state, return null, use basic user data</li>
            <li><strong>User Experience:</strong> Brief loading, then fallback to basic authentication</li>
        </ul>

        <h3>2. Profile Not Found (406)</h3>
        <ul>
            <li><strong>Cause:</strong> User profile doesn't exist in database</li>
            <li><strong>Handling:</strong> Clear loading state, return null, use session data</li>
            <li><strong>User Experience:</strong> Works with basic user information from session</li>
        </ul>

        <h3>3. Network Timeouts</h3>
        <ul>
            <li><strong>Cause:</strong> Slow network or server unresponsive</li>
            <li><strong>Handling:</strong> 10-second timeout, clear loading state</li>
            <li><strong>User Experience:</strong> Maximum 10 seconds of loading, then fallback</li>
        </ul>

        <h3>4. Database Errors</h3>
        <ul>
            <li><strong>Cause:</strong> Database connection issues or query failures</li>
            <li><strong>Handling:</strong> Retry once, then fallback to basic data</li>
            <li><strong>User Experience:</strong> Brief retry, then works with available data</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üöÄ Next Steps</h2>
        <p>After confirming the fixes work:</p>
        <ul>
            <li>Test with different user roles (owner, customer, admin)</li>
            <li>Test with users who have profiles and users who don't</li>
            <li>Test network connectivity issues (slow connection, offline)</li>
            <li>Test sign out and sign in flows</li>
            <li>Monitor console for any remaining errors</li>
            <li>Verify all dashboard pages load properly</li>
            <li>Test on different browsers and devices</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üìà Performance Improvements</h2>
        <ul>
            <li><strong>Faster Loading:</strong> Reduced retries from 3 to 1 for faster failure detection</li>
            <li><strong>Timeout Protection:</strong> Maximum 10 seconds of loading prevents infinite waits</li>
            <li><strong>Immediate Fallbacks:</strong> Uses session data when profile fetch fails</li>
            <li><strong>Better Error Recovery:</strong> System recovers quickly from errors</li>
            <li><strong>Clean State Management:</strong> Proper cleanup prevents memory leaks</li>
            <li><strong>Optimized Retries:</strong> Short delays (500ms) for quick retry attempts</li>
        </ul>
    </div>

    <script>
        console.log('üîê Authentication Loading Fix Test Page Loaded');
        console.log('üìã This page documents the fix for 403/406 errors and stuck loading states');
        console.log('üéØ The authentication system now handles errors gracefully and never gets stuck loading');
    </script>
</body>
</html>
